openapi: 3.0.3
info:
  title: CanopyX API
  description: |
    CanopyX provides three main API components:
    - **Admin API**: Chain management and monitoring (requires authentication)
    - **Query API**: Public blockchain data query interface
    - **Realtime API**: WebSocket stream of indexing events

    All APIs use JSON for request/response bodies unless otherwise noted.
  version: 1.0.0
  contact:
    name: Canopy Network
    url: https://canopy.network

servers:
  - url: http://localhost:3000
    description: Admin API (local development)
  - url: http://localhost:3001
    description: Query API (local development)

tags:
  - name: Admin - Health
    description: Health check endpoints
  - name: Admin - Auth
    description: Authentication and session management
  - name: Admin - Chains
    description: Chain configuration and management
  - name: Admin - Monitoring
    description: Chain monitoring and indexing progress
  - name: Admin - Operations
    description: Indexing operations (headscan, gapscan, reindex)
  - name: Query - Health
    description: Health check endpoints
  - name: Query - Realtime
    description: WebSocket streaming endpoints
  - name: Query - Entities
    description: Entity metadata endpoints
  - name: Query - Blocks
    description: Query blockchain blocks
  - name: Query - Block Summaries
    description: Aggregated per-block entity counts
  - name: Query - Transactions
    description: Query blockchain transactions
  - name: Query - Events
    description: Query indexed events
  - name: Query - Accounts
    description: Query account state snapshots
  - name: Query - Pools
    description: Query liquidity pools
  - name: Query - Orders
    description: Query order book snapshots
  - name: Query - Markets
    description: Cross-chain market data
  - name: Query - Analytics
    description: Derived analytics data
  - name: Query - Stats
    description: Chain statistics and metrics
  - name: Query - Schema
    description: Database schema information

paths:
  # ============================================================================
  # ADMIN API
  # ============================================================================

  /api/health:
    get:
      tags:
        - Admin - Health
      summary: Health check
      description: Returns the health status of the admin service.
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: string
                example: "1"

  /api/auth/login:
    post:
      tags:
        - Admin - Auth
      summary: Login
      description: Authenticate and receive a session cookie for the admin UI.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  example: admin
                password:
                  type: string
                  format: password
                  example: admin
      responses:
        '200':
          description: Login successful
          headers:
            Set-Cookie:
              description: Session cookie (`cx_session`)
              schema:
                type: string
                example: cx_session=abc123; Path=/; HttpOnly
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimpleOK'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/auth/logout:
    post:
      tags:
        - Admin - Auth
      summary: Logout
      description: Invalidate the current session cookie.
      responses:
        '204':
          description: Logout successful

  /api/chains:
    get:
      tags:
        - Admin - Chains
      summary: List chains
      description: Get all configured chains from the admin database.
      security:
        - bearerAuth: []
        - sessionAuth: []
      responses:
        '200':
          description: List of chains
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Chain'
        '401':
          $ref: '#/components/responses/Unauthorized'
    post:
      tags:
        - Admin - Chains
      summary: Create or update chain
      description: Upsert a chain configuration. Creates Temporal schedules and the ClickHouse database if needed.
      security:
        - bearerAuth: []
        - sessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChainInput'
      responses:
        '200':
          description: Chain created/updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimpleOK'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/chains/status:
    get:
      tags:
        - Admin - Chains
      summary: Get chain statuses
      description: Return per-chain indexing status, queue health, and head progress.
      security:
        - bearerAuth: []
        - sessionAuth: []
      responses:
        '200':
          description: Chain statuses keyed by chain ID
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  $ref: '#/components/schemas/ChainStatus'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'
    patch:
      tags:
        - Admin - Chains
      summary: Bulk update chain flags
      description: Pause, resume, or soft-delete multiple chains.
      security:
        - bearerAuth: []
        - sessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: '#/components/schemas/ChainStatusPatch'
      responses:
        '204':
          description: Chains updated successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/chains/{id}:
    get:
      tags:
        - Admin - Chains
      summary: Get chain
      description: Retrieve a single chain configuration by ID.
      security:
        - bearerAuth: []
        - sessionAuth: []
      parameters:
        - $ref: '#/components/parameters/ChainId'
      responses:
        '200':
          description: Chain details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Chain'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'
    patch:
      tags:
        - Admin - Chains
      summary: Update chain
      description: Partially update a chain configuration.
      security:
        - bearerAuth: []
        - sessionAuth: []
      parameters:
        - $ref: '#/components/parameters/ChainId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChainPatch'
      responses:
        '200':
          description: Chain updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimpleOK'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'
    delete:
      tags:
        - Admin - Chains
      summary: Delete chain
      description: Mark a chain as deleted and drop in-memory caches.
      security:
        - bearerAuth: []
        - sessionAuth: []
      parameters:
        - $ref: '#/components/parameters/ChainId'
      responses:
        '200':
          description: Chain deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimpleOK'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/chains/{id}/progress:
    get:
      tags:
        - Admin - Monitoring
      summary: Get last indexed height
      description: Return the most recently indexed block height for the chain.
      security:
        - bearerAuth: []
        - sessionAuth: []
      parameters:
        - $ref: '#/components/parameters/ChainId'
      responses:
        '200':
          description: Last indexed height
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProgressResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/chains/{id}/gaps:
    get:
      tags:
        - Admin - Monitoring
      summary: Get indexing gaps
      description: Return missing block ranges detected for the chain.
      security:
        - bearerAuth: []
        - sessionAuth: []
      parameters:
        - $ref: '#/components/parameters/ChainId'
      responses:
        '200':
          description: Gap ranges waiting to be indexed
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/GapRange'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/chains/{id}/progress-history:
    get:
      tags:
        - Admin - Monitoring
      summary: Get indexing progress history
      description: Historic indexing velocity aggregated into time buckets.
      security:
        - bearerAuth: []
        - sessionAuth: []
      parameters:
        - $ref: '#/components/parameters/ChainId'
        - name: hours
          in: query
          required: false
          description: Time window in hours (1-168).
          schema:
            type: integer
            minimum: 1
            maximum: 168
            default: 24
      responses:
        '200':
          description: Progress history buckets
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProgressHistoryPoint'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/chains/{id}/headscan:
    post:
      tags:
        - Admin - Operations
      summary: Trigger head scan
      description: Manually trigger a head scan workflow to index the latest head range.
      security:
        - bearerAuth: []
        - sessionAuth: []
      parameters:
        - $ref: '#/components/parameters/ChainId'
      responses:
        '200':
          description: Head scan triggered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimpleOK'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/chains/{id}/gapscan:
    post:
      tags:
        - Admin - Operations
      summary: Trigger gap scan
      description: Manually trigger a gap scan workflow to locate missing block ranges.
      security:
        - bearerAuth: []
        - sessionAuth: []
      parameters:
        - $ref: '#/components/parameters/ChainId'
      responses:
        '200':
          description: Gap scan triggered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SimpleOK'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /api/chains/{id}/reindex:
    post:
      tags:
        - Admin - Operations
      summary: Trigger manual reindex
      description: Queue manual reindex workflows for specific block heights or ranges.
      security:
        - bearerAuth: []
        - sessionAuth: []
      parameters:
        - $ref: '#/components/parameters/ChainId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReindexRequest'
      responses:
        '200':
          description: Reindex request queued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QueuedResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  # ============================================================================
  # QUERY API
  # ============================================================================

  /health:
    get:
      tags:
        - Query - Health
      summary: Health check
      description: Returns the health status of the query service (includes ClickHouse connectivity).
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
        '500':
          $ref: '#/components/responses/InternalError'

  /ws:
    get:
      tags:
        - Query - Realtime
      summary: Subscribe to realtime events
      description: >
        Upgrade the connection to WebSocket to receive streaming block indexing events.
        Clients must send `{"action":"subscribe","chainId":"<id>"}` messages to receive events for a chain.
      responses:
        '101':
          description: Switching protocols to WebSocket
        '503':
          description: Real-time events unavailable (Redis disabled)

  /entities:
    get:
      tags:
        - Query - Entities
      summary: List indexed entities
      description: Return metadata about all supported entities and associated API routes.
      responses:
        '200':
          description: Entity metadata
          content:
            application/json:
              schema:
                type: object
                properties:
                  entities:
                    type: array
                    items:
                      $ref: '#/components/schemas/EntityInfo'

  /chains/{id}/blocks:
    get:
      tags:
        - Query - Blocks
      summary: Query blocks
      description: Get blocks for a chain with cursor-based pagination.
      parameters:
        - $ref: '#/components/parameters/ChainId'
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Sort'
      responses:
        '200':
          description: Paginated blocks
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PagedResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Block'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /chains/{id}/blocks/{height}:
    get:
      tags:
        - Query - Blocks
      summary: Get block by height
      description: Retrieve a single block by height.
      parameters:
        - $ref: '#/components/parameters/ChainId'
        - $ref: '#/components/parameters/BlockHeight'
      responses:
        '200':
          description: Block details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Block'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /chains/{id}/block-summaries:
    get:
      tags:
        - Query - Block Summaries
      summary: Query block summaries
      description: Get per-block aggregate counts such as transactions by type.
      parameters:
        - $ref: '#/components/parameters/ChainId'
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Sort'
      responses:
        '200':
          description: Paginated block summaries
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PagedResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/BlockSummary'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /chains/{id}/block-summaries/{height}:
    get:
      tags:
        - Query - Block Summaries
      summary: Get block summary by height
      description: Retrieve the block summary for a specific height.
      parameters:
        - $ref: '#/components/parameters/ChainId'
        - $ref: '#/components/parameters/BlockHeight'
      responses:
        '200':
          description: Block summary details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BlockSummary'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /chains/{id}/transactions:
    get:
      tags:
        - Query - Transactions
      summary: Query transactions
      description: Get transactions for a chain with optional message-type filtering.
      parameters:
        - $ref: '#/components/parameters/ChainId'
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Sort'
        - $ref: '#/components/parameters/TransactionTypeFilter'
      responses:
        '200':
          description: Paginated transactions
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PagedResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Transaction'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /chains/{id}/transactions/{hash}:
    get:
      tags:
        - Query - Transactions
      summary: Get transaction by hash
      description: Retrieve a single transaction with parsed message data.
      parameters:
        - $ref: '#/components/parameters/ChainId'
        - $ref: '#/components/parameters/TransactionHash'
      responses:
        '200':
          description: Transaction details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransactionDetail'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /chains/{id}/transactions_raw:
    get:
      tags:
        - Query - Transactions
      summary: Query raw transactions
      description: Get raw transaction payloads (message, public key, signature).
      parameters:
        - $ref: '#/components/parameters/ChainId'
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Sort'
      responses:
        '200':
          description: Paginated raw transactions
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PagedResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/TransactionRaw'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /chains/{id}/events:
    get:
      tags:
        - Query - Events
      summary: Query events
      description: Get events emitted during block processing with optional type filtering.
      parameters:
        - $ref: '#/components/parameters/ChainId'
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Sort'
        - $ref: '#/components/parameters/EventTypeFilter'
      responses:
        '200':
          description: Paginated events
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PagedResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Event'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /chains/{id}/accounts:
    get:
      tags:
        - Query - Accounts
      summary: Query accounts
      description: Get account balance snapshots using cursor-based pagination.
      parameters:
        - $ref: '#/components/parameters/ChainId'
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Sort'
      responses:
        '200':
          description: Paginated accounts
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PagedResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Account'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /chains/{id}/accounts/{address}:
    get:
      tags:
        - Query - Accounts
      summary: Get account by address
      description: Retrieve account state, optionally at or before a specific height.
      parameters:
        - $ref: '#/components/parameters/ChainId'
        - $ref: '#/components/parameters/AccountAddress'
        - $ref: '#/components/parameters/AccountHeight'
      responses:
        '200':
          description: Account snapshot
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Account'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /chains/{id}/pools:
    get:
      tags:
        - Query - Pools
      summary: Query pools
      description: Get liquidity pool state snapshots.
      parameters:
        - $ref: '#/components/parameters/ChainId'
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Sort'
      responses:
        '200':
          description: Paginated pools
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PagedResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Pool'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /chains/{id}/orders:
    get:
      tags:
        - Query - Orders
      summary: Query orders
      description: Get order snapshots with optional status filtering.
      parameters:
        - $ref: '#/components/parameters/ChainId'
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Sort'
        - $ref: '#/components/parameters/OrderStatusFilter'
      responses:
        '200':
          description: Paginated orders
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PagedResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Order'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /chains/{id}/dex-prices:
    get:
      tags:
        - Query - Markets
      summary: Query DEX prices
      description: Get cross-chain DEX price snapshots with optional chain pair filters.
      parameters:
        - $ref: '#/components/parameters/ChainId'
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/Limit'
        - $ref: '#/components/parameters/Sort'
        - $ref: '#/components/parameters/DexPriceLocal'
        - $ref: '#/components/parameters/DexPriceRemote'
      responses:
        '200':
          description: Paginated DEX prices
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/PagedResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/DexPrice'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /chains/{id}/analytics/dex-volume:
    get:
      tags:
        - Query - Analytics
      summary: DEX volume (24h)
      description: Get 24-hour trading volume grouped by committee.
      parameters:
        - $ref: '#/components/parameters/ChainId'
      responses:
        '200':
          description: 24-hour DEX volume
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DexVolumeResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /chains/{id}/analytics/order-depth:
    get:
      tags:
        - Query - Analytics
      summary: Order book depth
      description: Aggregated open order depth grouped by price level.
      parameters:
        - $ref: '#/components/parameters/ChainId'
        - $ref: '#/components/parameters/Committee'
        - $ref: '#/components/parameters/Limit'
      responses:
        '200':
          description: Order book depth
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderBookDepthResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /chains/{id}/stats/hour:
    get:
      tags:
        - Query - Stats
      summary: Hourly statistics
      description: Get up to 500 hourly transaction counts for a chain.
      parameters:
        - $ref: '#/components/parameters/ChainId'
      responses:
        '200':
          description: Hourly transaction counts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/StatsHour'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /chains/{id}/stats/day:
    get:
      tags:
        - Query - Stats
      summary: Daily statistics
      description: Get the last 90 daily transaction count buckets for a chain.
      parameters:
        - $ref: '#/components/parameters/ChainId'
      responses:
        '200':
          description: Daily transaction counts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/StatsDay'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /chains/{id}/stats/24h:
    get:
      tags:
        - Query - Stats
      summary: Rolling 24-hour statistics
      description: Get the latest 24-hour transaction count snapshot for a chain.
      parameters:
        - $ref: '#/components/parameters/ChainId'
      responses:
        '200':
          description: 24-hour transaction snapshot
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Stats24h'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /chains/{id}/schema:
    get:
      tags:
        - Query - Schema
      summary: Get table schema
      description: Retrieve ClickHouse column metadata for a table.
      parameters:
        - $ref: '#/components/parameters/ChainId'
        - name: table
          in: query
          required: true
          description: Table name to inspect.
          schema:
            type: string
            enum:
              - blocks
              - txs
              - block_summaries
              - events
              - accounts
              - pools
              - orders
              - dex_prices
              - transactions
              - transactions_raw
      responses:
        '200':
          description: Table schema metadata
          content:
            application/json:
              schema:
                type: object
                properties:
                  columns:
                    type: array
                    items:
                      $ref: '#/components/schemas/ColumnInfo'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: Token
      description: |
        Admin token authentication for API access.
        Use the `ADMIN_TOKEN` environment variable value with the `Authorization: Bearer <token>` header.
    sessionAuth:
      type: apiKey
      in: cookie
      name: cx_session
      description: |
        Session-based authentication using an HTTP-only cookie issued by the `/api/auth/login` endpoint.
        Primarily used by the admin web UI.

  parameters:
    ChainId:
      name: id
      in: path
      required: true
      description: Chain identifier.
      schema:
        type: string
      example: example-chain

    BlockHeight:
      name: height
      in: path
      required: true
      description: Block height.
      schema:
        type: integer
        format: uint64
      example: 123456

    TransactionHash:
      name: hash
      in: path
      required: true
      description: Transaction hash.
      schema:
        type: string
      example: ABCDEF1234567890

    AccountAddress:
      name: address
      in: path
      required: true
      description: Account address.
      schema:
        type: string
      example: canopy1qqp6k9nqf6u3v5t8w0

    AccountHeight:
      name: height
      in: query
      required: false
      description: Return the account snapshot at or before this height.
      schema:
        type: integer
        format: uint64
      example: 500000

    Cursor:
      name: cursor
      in: query
      required: false
      description: Pagination cursor (exclusive). Uses the entity height for ordering.
      schema:
        type: integer
        format: uint64
        minimum: 0
      example: 12345

    Limit:
      name: limit
      in: query
      required: false
      description: Maximum number of results to return.
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 50
      example: 50

    Sort:
      name: sort
      in: query
      required: false
      description: Sort order (descending by default).
      schema:
        type: string
        enum: [asc, desc]
        default: desc
      example: desc

    TransactionTypeFilter:
      name: type
      in: query
      required: false
      description: Filter transactions by message type (e.g. `delegate`).
      schema:
        type: string

    EventTypeFilter:
      name: type
      in: query
      required: false
      description: Filter events by event type (e.g. `transfer`).
      schema:
        type: string

    OrderStatusFilter:
      name: status
      in: query
      required: false
      description: Filter orders by status.
      schema:
        type: string
        enum: [open, filled, cancelled, expired]

    DexPriceLocal:
      name: local
      in: query
      required: false
      description: Filter DEX prices by local chain ID. Provide together with `remote`.
      schema:
        type: integer
        format: uint64

    DexPriceRemote:
      name: remote
      in: query
      required: false
      description: Filter DEX prices by remote chain ID. Provide together with `local`.
      schema:
        type: integer
        format: uint64

    Committee:
      name: committee
      in: query
      required: true
      description: Committee identifier for analytics queries.
      schema:
        type: integer
        format: uint64
      example: 42

  schemas:
    SimpleOK:
      type: object
      properties:
        ok:
          type: string
          example: "1"

    QueuedResponse:
      type: object
      properties:
        queued:
          type: integer
          format: int32
          description: Number of items queued successfully.
          example: 3

    ProgressResponse:
      type: object
      properties:
        last:
          type: integer
          format: uint64
          description: Last indexed block height.
          example: 1234567

    GapRange:
      type: object
      properties:
        From:
          type: integer
          format: uint64
          description: Start of the missing block range (inclusive).
        To:
          type: integer
          format: uint64
          description: End of the missing block range (inclusive).
      example:
        From: 100
        To: 105

    Chain:
      type: object
      properties:
        chain_id:
          type: string
        chain_name:
          type: string
        rpc_endpoints:
          type: array
          items:
            type: string
        paused:
          type: integer
          enum: [0, 1]
        deleted:
          type: integer
          enum: [0, 1]
        image:
          type: string
        min_replicas:
          type: integer
          minimum: 1
        max_replicas:
          type: integer
          minimum: 1
        notes:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        rpc_health_status:
          type: string
        rpc_health_message:
          type: string
        rpc_health_updated_at:
          type: string
          format: date-time
        queue_health_status:
          type: string
        queue_health_message:
          type: string
        queue_health_updated_at:
          type: string
          format: date-time
        deployment_health_status:
          type: string
        deployment_health_message:
          type: string
        deployment_health_updated_at:
          type: string
          format: date-time
        overall_health_status:
          type: string
        overall_health_updated_at:
          type: string
          format: date-time

    ChainInput:
      type: object
      required:
        - chain_id
        - chain_name
        - rpc_endpoints
        - image
      properties:
        chain_id:
          type: string
        chain_name:
          type: string
        rpc_endpoints:
          type: array
          items:
            type: string
          minItems: 1
        image:
          type: string
        min_replicas:
          type: integer
          minimum: 1
          default: 1
        max_replicas:
          type: integer
          minimum: 1
          default: 1
        notes:
          type: string
          nullable: true

    ChainPatch:
      type: object
      properties:
        chain_name:
          type: string
        paused:
          type: integer
          enum: [0, 1]
        deleted:
          type: integer
          enum: [0, 1]
        rpc_endpoints:
          type: array
          items:
            type: string
        image:
          type: string
        notes:
          type: string
          nullable: true
        min_replicas:
          type: integer
          minimum: 1
        max_replicas:
          type: integer
          minimum: 1

    ChainStatusPatch:
      allOf:
        - type: object
          required:
            - chain_id
          properties:
            chain_id:
              type: string
        - $ref: '#/components/schemas/ChainPatch'

    HealthInfo:
      type: object
      properties:
        status:
          type: string
          description: Health status label.
        message:
          type: string
          description: Optional diagnostic message.
        updated_at:
          type: string
          format: date-time
          description: Last update timestamp.

    QueueStatus:
      type: object
      properties:
        pending_workflow:
          type: integer
          format: int64
        pending_activity:
          type: integer
          format: int64
        backlog_age_secs:
          type: number
          format: float
        pollers:
          type: integer
          format: int32

    ReindexEntry:
      type: object
      properties:
        height:
          type: integer
          format: uint64
        status:
          type: string
        requested_by:
          type: string
        requested_at:
          type: string
          format: date-time
        workflow_id:
          type: string
        run_id:
          type: string

    ChainStatus:
      type: object
      properties:
        chain_id:
          type: string
        chain_name:
          type: string
        image:
          type: string
        notes:
          type: string
          nullable: true
        paused:
          type: boolean
        deleted:
          type: boolean
        min_replicas:
          type: integer
        max_replicas:
          type: integer
        last_indexed:
          type: integer
          format: uint64
        head:
          type: integer
          format: uint64
        queue:
          $ref: '#/components/schemas/QueueStatus'
        ops_queue:
          $ref: '#/components/schemas/QueueStatus'
        indexer_queue:
          $ref: '#/components/schemas/QueueStatus'
        reindex_history:
          type: array
          items:
            $ref: '#/components/schemas/ReindexEntry'
        missing_blocks_count:
          type: integer
          format: uint64
        gap_ranges_count:
          type: integer
        largest_gap_start:
          type: integer
          format: uint64
        largest_gap_end:
          type: integer
          format: uint64
        is_live_sync:
          type: boolean
        live_queue_depth:
          type: integer
          format: int64
        live_queue_backlog_age:
          type: number
          format: float
        historical_queue_depth:
          type: integer
          format: int64
        historical_queue_backlog_age:
          type: number
          format: float
        health:
          $ref: '#/components/schemas/HealthInfo'
        rpc_health:
          $ref: '#/components/schemas/HealthInfo'
        queue_health:
          $ref: '#/components/schemas/HealthInfo'
        deployment_health:
          $ref: '#/components/schemas/HealthInfo'

    ProgressHistoryPoint:
      type: object
      properties:
        time:
          type: string
          format: date-time
        height:
          type: integer
          format: uint64
        avg_latency:
          type: number
          format: float
        avg_processing_time:
          type: number
          format: float
        blocks_indexed:
          type: integer
          format: uint32
        velocity:
          type: number
          format: float

    ReindexRequest:
      type: object
      description: Provide explicit block heights or a height range to reindex.
      properties:
        heights:
          type: array
          items:
            type: integer
            format: uint64
          description: Unique block heights to reindex.
        from:
          type: integer
          format: uint64
          description: Inclusive start of a block range to reindex.
        to:
          type: integer
          format: uint64
          description: Inclusive end of a block range to reindex.
      example:
        heights: [100, 101, 102]

    Block:
      type: object
      properties:
        height:
          type: integer
          format: uint64
        hash:
          type: string
        time:
          type: string
          format: date-time
        parent_hash:
          type: string
        proposer_address:
          type: string
        size:
          type: integer
          format: int32

    BlockSummary:
      type: object
      properties:
        height:
          type: integer
          format: uint64
        height_time:
          type: string
          format: date-time
        num_txs:
          type: integer
          format: uint32
        tx_counts_by_type:
          type: object
          additionalProperties:
            type: integer
            format: uint32

    PagedResponse:
      type: object
      properties:
        limit:
          type: integer
        next_cursor:
          type: integer
          format: uint64
          nullable: true
          description: Cursor for the next page; null if there are no more results.

    Transaction:
      type: object
      properties:
        height:
          type: integer
          format: uint64
        tx_hash:
          type: string
        time:
          type: string
          format: date-time
        height_time:
          type: string
          format: date-time
        message_type:
          type: string
        signer:
          type: string
        counterparty:
          type: string
          nullable: true
        amount:
          type: integer
          format: uint64
          nullable: true
        fee:
          type: integer
          format: uint64
        validator_address:
          type: string
          nullable: true
        commission:
          type: number
          format: float
          nullable: true
        chain_id:
          type: integer
          format: uint64
          nullable: true
        sell_amount:
          type: integer
          format: uint64
          nullable: true
        buy_amount:
          type: integer
          format: uint64
          nullable: true
        liquidity_amount:
          type: integer
          format: uint64
          nullable: true
        order_id:
          type: string
          nullable: true
        price:
          type: number
          format: float
          nullable: true
        param_key:
          type: string
          nullable: true
        param_value:
          type: string
          nullable: true
        committee_id:
          type: integer
          format: uint64
          nullable: true
        recipient:
          type: string
          nullable: true
        msg:
          type: string
        public_key:
          type: string
          nullable: true
        signature:
          type: string
          nullable: true
        created_height:
          type: integer
          format: uint64

    TransactionRaw:
      type: object
      properties:
        height:
          type: integer
          format: uint64
        tx_hash:
          type: string
        height_time:
          type: string
          format: date-time
        msg:
          type: string
        public_key:
          type: string
          nullable: true
        signature:
          type: string
          nullable: true

    TransactionDetail:
      type: object
      properties:
        transaction:
          $ref: '#/components/schemas/Transaction'
        message:
          type: object
          nullable: true
          additionalProperties: {}
      required:
        - transaction

    Event:
      type: object
      properties:
        height:
          type: integer
          format: uint64
        chain_id:
          type: integer
          format: uint64
        address:
          type: string
        reference:
          type: string
        event_type:
          type: string
        amount:
          type: integer
          format: uint64
          nullable: true
        sold_amount:
          type: integer
          format: uint64
          nullable: true
        bought_amount:
          type: integer
          format: uint64
          nullable: true
        local_amount:
          type: integer
          format: uint64
          nullable: true
        remote_amount:
          type: integer
          format: uint64
          nullable: true
        success:
          type: boolean
          nullable: true
        local_origin:
          type: boolean
          nullable: true
        order_id:
          type: string
          nullable: true
        msg:
          type: string
        height_time:
          type: string
          format: date-time

    Account:
      type: object
      properties:
        Address:
          type: string
        Amount:
          type: integer
          format: uint64
        Height:
          type: integer
          format: uint64
        HeightTime:
          type: string
          format: date-time
        CreatedHeight:
          type: integer
          format: uint64

    Pool:
      type: object
      properties:
        pool_id:
          type: integer
          format: uint64
        height:
          type: integer
          format: uint64
        chain_id:
          type: integer
          format: uint64
        amount:
          type: integer
          format: uint64
        total_points:
          type: integer
          format: uint64
        lp_count:
          type: integer
          format: int32
        height_time:
          type: string
          format: date-time

    Order:
      type: object
      properties:
        OrderID:
          type: string
        Height:
          type: integer
          format: uint64
        HeightTime:
          type: string
          format: date-time
        Committee:
          type: integer
          format: uint64
        AmountForSale:
          type: integer
          format: uint64
        RequestedAmount:
          type: integer
          format: uint64
        SellerAddress:
          type: string
        BuyerAddress:
          type: string
          nullable: true
        Deadline:
          type: integer
          format: uint64
          nullable: true
        Status:
          type: string
        CreatedHeight:
          type: integer
          format: uint64

    DexPrice:
      type: object
      properties:
        local_chain_id:
          type: integer
          format: uint64
        remote_chain_id:
          type: integer
          format: uint64
        height:
          type: integer
          format: uint64
        local_pool:
          type: integer
          format: uint64
        remote_pool:
          type: integer
          format: uint64
        price_e6:
          type: integer
          format: uint64
        height_time:
          type: string
          format: date-time

    DexVolumeResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/DexVolumeStats'

    OrderBookDepthResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/OrderBookLevel'

    DexVolumeStats:
      type: object
      properties:
        committee:
          type: integer
          format: uint64
        total_orders:
          type: integer
          format: uint64
        volume_for_sale:
          type: integer
          format: uint64
        volume_requested:
          type: integer
          format: uint64
        last_price:
          type: integer
          format: uint64
          nullable: true

    OrderBookLevel:
      type: object
      properties:
        committee:
          type: integer
          format: uint64
        price_e6:
          type: integer
          format: uint64
        total_for_sale:
          type: integer
          format: uint64
        total_requested:
          type: integer
          format: uint64
        order_count:
          type: integer
          format: int32

    EntityInfo:
      type: object
      properties:
        name:
          type: string
        table_name:
          type: string
        staging_name:
          type: string
        route_path:
          type: string

    StatsHour:
      type: object
      properties:
        hour:
          type: string
          format: date-time
        count:
          type: integer
          format: uint64

    StatsDay:
      type: object
      properties:
        day:
          type: string
          format: date
        count:
          type: integer
          format: uint64

    Stats24h:
      type: object
      properties:
        asof:
          type: string
          format: date-time
        count:
          type: integer
          format: uint64

    ColumnInfo:
      type: object
      properties:
        name:
          type: string
        type:
          type: string

    Error:
      type: object
      properties:
        error:
          type: string

  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Unauthorized - authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'