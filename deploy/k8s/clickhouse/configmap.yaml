apiVersion: v1
kind: ConfigMap
metadata:
  name: clickhouse-storage-config
  namespace: default
data:
  storage-policy.xml: |
    <clickhouse>
        <!-- Storage Configuration for Tiered Storage (Hot/Warm/Cold) -->
        <storage_configuration>
            <!-- Define storage disks -->
            <disks>
                <!-- Hot storage: Fast NVMe for recent data (last 30 days) -->
                <hot>
                    <path>/var/lib/clickhouse/hot/</path>
                    <keep_free_space_bytes>10737418240</keep_free_space_bytes> <!-- 10GB free space -->
                </hot>

                <!-- Warm storage: SSD for medium-term data (30-180 days) -->
                <warm>
                    <path>/var/lib/clickhouse/warm/</path>
                    <keep_free_space_bytes>10737418240</keep_free_space_bytes> <!-- 10GB free space -->
                </warm>

                <!-- Cold storage: HDD for long-term data (180+ days) -->
                <cold>
                    <path>/var/lib/clickhouse/cold/</path>
                    <keep_free_space_bytes>10737418240</keep_free_space_bytes> <!-- 10GB free space -->
                </cold>
            </disks>

            <!-- Define storage policies -->
            <policies>
                <!-- Tiered storage policy: automatically moves data based on TTL -->
                <tiered_storage>
                    <volumes>
                        <!-- Hot volume: Recent data on fast storage -->
                        <hot>
                            <disk>hot</disk>
                            <!-- Max 50GB per partition on hot storage before moving to warm -->
                            <max_data_part_size_bytes>53687091200</max_data_part_size_bytes>
                        </hot>

                        <!-- Warm volume: Medium-term data on SSD -->
                        <warm>
                            <disk>warm</disk>
                            <!-- Max 500GB per partition on warm storage before moving to cold -->
                            <max_data_part_size_bytes>536870912000</max_data_part_size_bytes>
                        </warm>

                        <!-- Cold volume: Long-term data on cheap HDD -->
                        <cold>
                            <disk>cold</disk>
                        </cold>
                    </volumes>

                    <!-- Move data when volume is 80% full -->
                    <move_factor>0.2</move_factor>
                </tiered_storage>

                <!-- Default policy: everything on hot storage (for non-tiered tables) -->
                <default>
                    <volumes>
                        <main>
                            <disk>hot</disk>
                        </main>
                    </volumes>
                </default>
            </policies>
        </storage_configuration>

        <!-- Compression settings -->
        <compression>
            <!-- Default compression for all tables -->
            <case>
                <min_part_size>10485760</min_part_size> <!-- 10MB -->
                <min_part_size_ratio>0.01</min_part_size_ratio>
                <method>zstd</method>
                <level>3</level> <!-- ZSTD level 3: good balance of speed/compression -->
            </case>
        </compression>
    </clickhouse>