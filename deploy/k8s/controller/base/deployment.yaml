apiVersion: apps/v1
kind: Deployment
metadata:
  name: canopyx-controller
spec:
  replicas: 1
  selector:
    matchLabels:
      app: canopyx-controller
  template:
    metadata:
      labels:
        app: canopyx-controller
    spec:
      serviceAccountName: canopyx-controller

      # DNS optimization: reduce DNS lookup latency in Kubernetes
      # ndots=1 prevents unnecessary search domain lookups for fully-qualified domain names
      dnsConfig:
        options:
          - name: ndots
            value: "1"

      # InitContainer in the future maybe run migrations once needed.
      containers:
        - name: controller
          image: localhost:5001/canopyx-controller
          env:
            # Logging
            - { name: LOG_LEVEL, value: "info" }
            # ADMIN server
            - { name: ADDR, value: ":3002" }
            - { name: K8S_NAMESPACE, value: "default" }
            - { name: INDEXER_IMAGE, value: "localhost:5001/canopyx-indexer" }
            - { name: INDEXER_TAG, value: "dev" }
            - { name: INDEXER_REPLICAS, value: "1" }
            - { name: INDEXER_ENABLE_HPA, value: "true" }
            - { name: INDEXER_HPA_MIN, value: "1" }
            - { name: INDEXER_HPA_MAX, value: "1" }
            - { name: INDEXER_HPA_CPU_TARGET, value: "80" }
            - { name: INDEXER_CPU, value: "2000m" }
            - { name: INDEXER_MEM, value: "2Gi" }
            - { name: TEMPORAL_TASK_QUEUE_PREFIX, value: "index:" }
            - { name: TEMPORAL_HOSTPORT, value: "temporal-frontend.default.svc.cluster.local:7233" }
            - { name: TEMPORAL_NAMESPACE, value: "canopyx" }
            # ClickHouse connection - Multiple replicas for failover with ConnOpenInOrder strategy
            # Connects to replica-0 by default, falls back to replica-1 on failure
            # Provides read-after-write consistency without Keeper overhead
            - { name: CLICKHOUSE_ADDR, value: "clickhouse://canopyx:canopyx@chi-canopyx-canopyx-0-0.default.svc.cluster.local:9000?secure=false" }
            # ClickHouse connection strategy: in_order (default), round_robin, or random
            # in_order provides read-after-write consistency for indexer
            - { name: CLICKHOUSE_CONN_STRATEGY, value: "in_order" }
            # ClickHouse connection pool configuration
            # Controller calculates pool sizes deterministically based on reconciliation needs (5 concurrent queries)
            # Formula: (5 queries × 2 connections) + 5 buffer = 15 total connections
            - { name: CLICKHOUSE_CONN_MAX_LIFETIME, value: "1h" }
            # Parallelism configuration - Indexer component (passed to indexer pods)
            # Indexer calculates connection pool sizes and Temporal worker limits from these values
            # Formula: (parallel_blocks × 20 activities × 8 connections) + 100 buffer
            # Example: (2+5+5) × 20 × 8 + 100 = 2,020 total connections per indexer replica
            - { name: LIVE_PARALLEL_BLOCKS, value: "2" }
            - { name: HISTORICAL_PARALLEL_BLOCKS, value: "5" }
            - { name: REINDEX_PARALLEL_BLOCKS, value: "5" }
            # Indexer image pull configuration (passed to indexer pods)
            # - { name: INDEXER_PULL_POLICY, value: "Always" }  # Always, IfNotPresent, Never
            # - { name: INDEXER_PULL_SECRET, value: "" }  # Name of imagePullSecret if needed
            # Scheduler configuration (passed to indexer pods) - Customizable for different chain block times
            # - { name: SCHEDULER_CATCHUP_THRESHOLD, value: "" }
            # - { name: DIRECT_SCHEDULE_BATCH_SIZE, value: "" }
            # - { name: SCHEDULER_BATCH_SIZE, value: "" }
            # - { name: BLOCK_TIME_SECONDS, value: "" }
            # - { name: SCHEDULER_BATCH_MAX_PARALLELISM, value: "" }
            # Databases
            - { name: INDEXER_DB, value: "canopyx_indexer" }
            # Redis (real-time event notifications)
            - { name: REDIS_HOST, value: "redis-master.default.svc.cluster.local" }
            - { name: REDIS_PORT, value: "6379" }
            - { name: REDIS_PASSWORD, value: "canopy-redis-dev" }
            - { name: REDIS_DB, value: "0" }
            # Kind of Provider:
            # Switch this to fake if you want to locally run the indexer or run it manually controller act
            - { name: PROVIDER, value: "k8s" }
            # - { name: PROVIDER, value: "fake" } # default one
          ports:
            - name: http
              containerPort: 3002
          readinessProbe:
            httpGet:
              path: /healthz
              port: 3002
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            successThreshold: 1
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /healthz
              port: 3002
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
