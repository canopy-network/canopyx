apiVersion: apps/v1
kind: Deployment
metadata:
  name: canopyx-query
spec:
  replicas: 1
  selector:
    matchLabels:
      app: canopyx-query
  template:
    metadata:
      labels:
        app: canopyx-query
    spec:
      containers:
        - name: query
          image: localhost:5001/canopyx-query
          env:
            # Logging
            - { name: LOG_LEVEL, value: "debug" }
            # Query server
            - { name: ADDR, value: ":3001" }
            # ClickHouse connection
            - { name: CLICKHOUSE_ADDR, value: "clickhouse://clickhouse-hdx-oss-v2-clickhouse.default.svc.cluster.local:9000?sslmode=disable" }
            # CHDEBUG=1 logs failed queries
            # CHDEBUG=2 logs all queries
            - { name: CHDEBUG, value: "1" }
            # Databases
            - { name: INDEXER_DB, value: "canopyx_indexer" }
            - { name: REPORTS_DB, value: "canopyx_reports" }
            # Redis (real-time WebSocket events)
            - { name: REDIS_ENABLED, value: "true" }
            - { name: REDIS_HOST, value: "redis-master.default.svc.cluster.local" }
            - { name: REDIS_PORT, value: "6379" }
            - { name: REDIS_PASSWORD, value: "canopy-redis-dev" }
            - { name: REDIS_DB, value: "0" }
          ports:
            - name: http
              containerPort: 3001
          readinessProbe:
            httpGet:
              path: /health
              port: 3001
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 5
            successThreshold: 1
            failureThreshold: 6
          livenessProbe:
            httpGet:
              path: /health
              port: 3001
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
